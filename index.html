<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
        <link href="./static/css/style.css" type="text/css"  rel="stylesheet" >
        <link rel="icon" href="./static/images/logo.png" />
        <title>JustStreamIt|Homepage</title>
</head>
<body>
  <div id="proj">
     <header class="proj__header">
        <img class="proj__header__logo" src="./static/images/logo.png" alt="logo" />
         <nav class="proj__header__nav">
            <ul class="proj__header__nav__link"  >
                <li >
                    <a href="/">Homepage</a>
                </li>
                <li>
                     <a href="/">Categories</a>
                </li>
            </ul>
        </nav>
     </header>
    <main id="main" class="proj__content">
       <section id="bestmovie_id" class="bestmovie">
       </section>
   </main>
    <footer class="proj__footer">
            &copy; Copyright 2022 by <a href="http://localhost:5000">Delphine Pythonique</a>.
    </footer>
  </div>
<!-- Trigger/Open The Modal -->


    <!-- The Modal -->
    <div id="movieDetailModalId" class="movieDetailModal">

      <!-- Modal content -->
      <div class="movieDetailModal__content">
        <span class="movieDetailModal__close">&times;</span>
        <div id="movieDetailModal__content__paragraph">Some text in the Modal..</div>
      </div>

    </div>
</body>
<script>

 //---------------------------CATEGORIES----------------------------------------
   class Category{
        constructor(name, elementToPopulateId, criteria, isCategorySection=true){
            this.name = name;
            this.activePage = 1;
            this.elementToPopulateId = elementToPopulateId;
            this.nextButonnId = `${elementToPopulateId}__next`;
            this.criteria = criteria;
            this.isCategorySection = isCategorySection;
        };

        getUrl(){
            return `${domain_uri}?page=${this.activePage}&${this.criteria.join("&")}`;
        }
   }
        const categories  = [
            new Category("Best Movie","bestmovie_id",["sort_by=-imdb_score"], false),
            new Category("Top Rated","category__toprated",["sort_by=-imdb_score"]),
            new Category("Action", "category__categoryone",["genre=Action","sort_by=-imdb_score"]),
            new Category("Drama", "category__categorytwo",["genre=Drama","sort_by=-imdb_score"]),
            new Category("Romance", "category__categorythree",["genre=Romance","sort_by=-imdb_score"])
        ]
        const domain_uri = "http://localhost:8000/api/v1/titles/";
        const scrollIndent = 200;

//---------------------------CREATE DOM and LINK EVENT----------------------------------------
//-----Category section -------
   function createSection(category){
        innerCategory = `<button id=\"${category.elementToPopulateId}__previous\" class=\"previous\"  > < </button> \
                <ul id=\"${category.elementToPopulateId}\"> </ul> \
                <button id=\"${category.elementToPopulateId}__next\" class=\"next\"  > > </button> \
                `;

         const main = document.getElementById("main");
         const title = document.createElement("h1");
         title.innerHTML = category.name;
         const categorySection = document.createElement("section");

         categorySection.classList.add("category", category.elementToPopulateId);
         categorySection.innerHTML = innerCategory;
         main.appendChild(categorySection);
         main.insertBefore(title, categorySection);

        return categorySection;
   }

   let scrollToPrevious = category => function(){
           const elementToScroll = document.getElementById(category.elementToPopulateId);
           elementToScroll.scrollLeft -= scrollIndent;
   };

   let scrollToNext = category => function(){
        category.activePage++;
        fetchCategoryMovies(category);
       const elementToScroll = document.getElementById(category.elementToPopulateId);
       elementToScroll.scrollLeft += scrollIndent;
   };

   function attachEventToScrollButton(category){
        let previousButton = document.getElementById(category.elementToPopulateId+"__previous");
        previousButton.addEventListener('click',
            scrollToPrevious(category));
        let NextButton = document.getElementById(category.elementToPopulateId+"__next");
        NextButton.addEventListener('click',
            scrollToNext(category));
   }
//-----Categorie section movies
         function populateCategories(movies, category){
           const ulCategory = document.getElementById(category.elementToPopulateId);
           for (let i in movies) {
               let imageMovie = document.createElement("img");
               imageMovie.setAttribute("src",movies[i].image_url);
               imageMovie.setAttribute("movie_id",movies[i].id);
               imageMovie.classList.add("movie");
               let liMovie = document.createElement("li");
               liMovie.appendChild(imageMovie);
               ulCategory.appendChild(liMovie);
               imageMovie.addEventListener('click',openDetailMovieModal())
           }
       }

       let openDetailMovieModal = () => function(){
            url = `${domain_uri}${this.getAttribute('movie_id')}`;

           fetchMovieApi(url).then(movie => {
               let movieDetailmodal = document.getElementById('movieDetailModalId');
               movieDetailmodal.style.display = "block";
               let movieDetailModalContentParagraph = document.getElementById('movieDetailModal__content__paragraph');
               let innerHTML = `<div> \
                                    <img src=\"${movie.image_url}\" /> \
                                    <h1>${movie.title}</h1> \
                                 </div> \
                                <div> \
                                    <p> \
                                        <b>Genres:</b>${movie.genres.join(',')} <br>\
                                        <b>Date Published:</b>${movie.date_published}<br> \
                                        <b>Rated:</b>${movie.rated} <br>\
                                        <b>Imdb score:</b>${movie.imdb_score} \
                                        <b>Directors:</b>${movie.directors.join(',')} <br>\
                                        <b>Actors:</b>${movie.actors.join(',')} <br>\
                                        <b>Duration:</b>${movie.duration}<br> \
                                        <b>Votes:</b>${movie.votes}<br> \
                                        <b>Long description:</b>${movie.long_description}<br> \
                                      </p> \
                                </div>`;
               movieDetailModalContentParagraph.innerHTML = innerHTML;

               console.log(movie.title);
           });

       }
//-------- Best Movie section
        function populateBestMovie(movie, category){
           const bestMovieSection = document.getElementById(category.elementToPopulateId);

           const innerHtml = `<div  class="bestmovie__text"> \
                                <h1>${movie.title}</h1> \
                                <p>${movie.description}</p> \
                              </div> \
                            <div class="bestmovie__img"> \
                                    <img movie_id="${movie.id}" id="bestmovie__img__img"  class="movie" src="${movie.image_url}" alt="logo" /> \
                            </div>`;
           bestMovieSection.innerHTML =innerHtml;
            const imageMovie = document.getElementById('bestmovie__img__img')
           imageMovie.addEventListener('click',openDetailMovieModal())
       }

//---------------------------FETCH MOVIES----------------------------------------
    async function fetchMoviesApi(url){
       const response = await fetch(url);
       const movies = await response.json();
       return movies.results
    }
   async function fetchMovieApi(url){
       const response = await fetch(url);
       const movie = await response.json();
       return movie
    }

   function fetchCategoryMovies(category) {
       let url = category.getUrl();
       let section;
       if (category.activePage == 1) {
           section = createSection(category);
           attachEventToScrollButton(category);
       }
       fetchMoviesApi(url).then(movies => {
           populateCategories(movies, category)
       });
   }

   function fetchBestMovie(category) {
       let url = category.getUrl();
       fetchMoviesApi(url).then(movies => {
           let movieId = movies[0].id;
           url = `${domain_uri}${movieId}`;
           //fetchMovieApi sans s
           fetchMovieApi(url).then(movie => {
               populateBestMovie(movie, category)
           });

       });
    }

    function populateHomePage(){
       for (let i in categories) {
           if (categories[i].isCategorySection) {
               fetchCategoryMovies(categories[i]);
           } else {
               fetchBestMovie(categories[i])
           }
        };
    }
       populateHomePage();
       attachEventOpenModalDetailMovieToImageMovie();

       function attachEventOpenModalDetailMovieToImageMovie() {

           var movieDetailmodal = document.getElementById("movieDetailModalId");
           var span = document.getElementsByClassName("movieDetailModal__close")[0];
           span.onclick = function () {
               movieDetailmodal.style.display = "none";
           }
           window.onclick = function (event) {
               if (event.target == movieDetailmodal) {
                   movieDetailmodal.style.display = "none";
               }
           }
       }

    </script>
</html>